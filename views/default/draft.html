{{left_sidebar_enabled,right_sidebar_enabled=False,('message' in globals())}}
{{extend 'layout.html'}}

<div id="target"></div>

<script id="template" type="text/ractive">
<div id="buttons">
    {{=A('Overview',  _class='btn btn-warning', _href=URL('default', 'index'))}}
    {% #if !all_ready %}
        {% #if user_team.ready == 'False' %}
        <input class="btn btn-primary" type="button" value="Start drafting" on-click="startdraft">
        {% else %}
        <input class="btn btn-primary" type="button" value="Stop drafting" on-click="stopdraft">
        {% /if %}
    {% /if %}
    <input class="btn btn-primary" type="button" value="Reset" on-click="resetdraft">
</div>

<hr>
    <h1 align="center">Draft</h1>
    {% #if loading_teams || loading_players %}
        <div id="load_spinner">
            <i class="fa fa-spinner fa-pulse fa-4x"></i>
        </div>
    {% else %}

<table width="100%">
<tr>
    <td align="center">
    <h2>Teams</h2>
    <table border="1" width="75%">
        <tr>
            <td align="center"><h4>Ready:</h4></td>
            <td align="center"><h4>Team name:</h4></td>
        </tr>
        {% #each team_list %}
        <tr>
            <td align="center">
            {% #if ready == 'True' %}
                <i class="fa fa-check"></i>
            {% else %}
                <i class="fa fa-times"></i>
            {% /if %}
            </td>
            <td align="center">{% name %}</td>
        </tr>
        {% /each %}
    </table>

    </td>
    <td align="center">

    <h2>Players</h2>
    <table border="1" width="75%">
        <tr>
            <td align="center"><h4>Player name:</h4></td>
            <td align="center"><h4>Pos:</h4></td>
            <td align="center"><h4>Points:</h4></td>
        </tr>
        {% #each player_list %}
        <tr on-click='pick_player' id='{% id %}' data-id="{% id %}">
            <td align="center">{% name %}{% team %}</td>
            <td align="center">{% pos %}</td>
            <td align="center">{% points %}</td>
        </tr>
        {% /each %}
    </table>

    </td>
    <td align="center">

    <h2>{% user_team.name %}</h2>
    <table border="1" width="75%">
        <tr>
            <td align="center"><h4>Position:</h4></td>
            <td align="center"><h4>Player name:</h4></td>
        </tr>
        {% #each user_players %}
        <tr>
            <td align="center">{% pos %}</td>
            <td align="center">{% name %}</td>
        </tr>
        {% /each %}
    </table>

    </td>
</tr>
</table>
{% /if %}

</script>

<script>
$(function() {
    var MAIN = new Ractive({
        el: '#target',
        template: '#template',
        delimiters: ['{%', '%}'],
        tripleDelimiters: ['{%%', '%%}'],
        data: {
            player_list: {},
            team_list: {},
            user_team: {},
            user_players: {},
            loading_players: true,
            loading_teams: true,
            all_ready: false
        }
    });

    load_teams();
    load_players();
    load_user_team();

    function start_turn() {

    }

    function end_turn() {

    }

    function load_players() {
        $.ajax("{{=URL('default', 'load_players', user_signature=True)}}",
            {
                method: 'POST',
                success: function (data) {
                    MAIN.set('player_list', data['player_list']);
                    MAIN.set('loading_players', false);
                }
            }
        );
    }

    function load_teams() {
        $.ajax("{{=URL('default', 'load_teams', user_signature=True)}}",
            {
                method: 'POST',
                success: function (data) {
                    var team_list = data['team_list'];
                    MAIN.set('team_list', team_list);
                    MAIN.set('user_team', data['user_team']);
                    MAIN.set('loading_teams', false);

                    var all_ready = true;

                    for (var t in team_list) {
                        if (team_list[t].ready == 'False')
                            all_ready = false;
                    }

                    MAIN.set('all_ready', all_ready)
                }
            }
        );
    }

    function load_user_team() {
        $.ajax("{{=URL('default', 'load_user_team', args=[team_id], user_signature=True)}}",
            {
                method: 'POST',
                success: function (data) {
                    MAIN.set('user_players', data['user_players']);
                }
            }
        );
    }

    MAIN.on("startdraft", function add_team() {
        var team = MAIN.get('user_team');
        $.ajax("{{=URL('default', 'draft_add_team', user_signature=True)}}",
            {
                data: {
                    team_id: team.id
                },
                method: 'POST',
                success: function () {
                    load_teams();
                }
            }
        );
    });

    MAIN.on("stopdraft", function remove_team() {
        var team = MAIN.get('user_team');
        $.ajax("{{=URL('default', 'draft_remove_team', user_signature=True)}}",
            {
                data: {
                    team_id: team.id
                },
                method: 'POST',
                success: function () {
                    load_teams();
                }
            }
        );
    });

    MAIN.on("pick_player", function pick_player(e) {
        var all_ready = MAIN.get('all_ready');
        if (all_ready) {
            var user_players = MAIN.get('user_players');
            var player_list = MAIN.get('player_list');
            var id = $(e.node).data('id');
            var player = null;

            for (var p in player_list) {
                if (player_list[p].id == id) {
                    player = player_list[p];
                }
            }

            if (player.team != null) {
                return;
            }

            var have_pos = false;
            for (var i in user_players) {
                if (user_players[i].pos == player.pos) {
                    have_pos = true;
                }
            }

            if (!have_pos) {
                $.ajax("{{=URL('default', 'add_user_player', args=[team_id], user_signature=True)}}",
                        {
                            data: {
                                player_id: player.id
                            },
                            method: 'POST',
                            success: function () {
                                for (var j in player_list) {
                                    if (player_list[j].id == player.id)
                                        player_list.splice(j, 1);
                                }
                                user_players.append(player);
                                MAIN.set('user_players', user_players);
                            }
                        }
                );
            }
            load_players();
        }
    });

    MAIN.on("resetdraft", function() {
        $.ajax("{{=URL('default', 'reset_draft', user_signature=True)}}");
        load_players();
    });

    setInterval(load_teams, 10000);
    setInterval(load_players, 10000);
});
</script>